#! /usr/bin/env python3

import os
import os.path
import glob
import time

from joblib import dump, load
import lzma
import lz4

FILEDIR='/tmp'

compfns = (
        ('lz4', lz4.frame.compress, lz4.frame.decompress),
        ('lzma', lzma.compress, lzma.decompress)
        )


for comptype,compfn,decompfn in compfns:
    for fn in glob.glob('/tmp/testdata*'):
        #print(f'{comptype} compressing {fn}...')
        start = time.perf_counter()
        with open(fn, 'rb') as fd:
            data = fd.read()
        bsize = os.path.getsize(fn) / 1024 / 1024
        #print(f'File read took {time.perf_counter()-start:.3f}secs')

        outfile = os.path.dirname(fn) + '/' + comptype + '.' + os.path.basename(fn)
        outfile = os.path.dirname(fn) + '/' + comptype + '.' + os.path.basename(fn)
        with open(outfile, 'wb') as fd:
            start = time.perf_counter()
            dump(data, fd, compress=comptype)
            timer = time.perf_counter()-start
        asize = os.path.getsize(outfile) / 1024 / 1024
        print(f'{outfile}\t{time.perf_counter()-start:.3f}secs\t{round(bsize, 1)}M -> {round(asize, 1)}M')
        with open(outfile, 'rb') as fd:
            edata = load(fd)
        if data != edata:
            print('WARNING: extracted data not the same')

